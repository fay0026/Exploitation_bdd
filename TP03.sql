--FAY Damien INF-S2 TP5B

--R21
SELECT  C.cp AS "Code Postal",
        C.localite AS "Localité",
        TPCTR.inttpctr AS "Type Contrat",
        COUNT(CTR.cdctr) AS "Nb contrats"
FROM    LOCVEC.CLIENT C
        INNER JOIN LOCVEC.CONTRAT CTR ON (C.cdcli = CTR.cdcli)
        INNER JOIN LOCVEC.TYPECONTRAT TPCTR ON (CTR.cdtpctr = TPCTR.cdtpctr)
WHERE   C.cp LIKE '51%'
        AND UPPER(tpctr.inttpctr) LIKE '%FORFAIT%'
GROUP   BY C.cp, C.localite, TPCTR.inttpctr
ORDER   BY "Localité", "Type Contrat";

--R22
SELECT  E.nom||' '||E.prnm AS "Employé",
        COUNT(CTR.cdemp) AS "Nb Contrats"
FROM    LOCVEC.EMPLOYE E
        LEFT JOIN LOCVEC.CONTRAT CTR ON (E.cdemp = CTR.cdemp)
WHERE   UPPER(E.qualif) = 'COMMERCIAL'
GROUP   BY E.nom, E.prnm;

--R23
SELECT  CTG.intctg AS Catégorie,
        MO.tpmdl AS Modèle,
        COUNT(VE.cdmdl) AS "nb Véhicule",
        ROUND(AVG(VE.kmactl), 2) AS "Nb moyen de km"
FROM    LOCVEC.CATEGORIE CTG
        INNER JOIN LOCVEC.MODELE MO ON (CTG.cdctg = MO.cdctg)
        INNER JOIN LOCVEC.VEHICULE VE ON (MO.cdmdl = VE.cdmdl)
GROUP   BY CTG.intctg, MO.tpmdl
HAVING  COUNT(VE.cdmdl) >= 2;

--R24
SELECT  MO.tpmdl AS Modèle,
        VE.imtrcl AS Immatriculation,
        ROUND(AVG(CTR.kmrtr-CTR.kmdpt), 0) AS "Nb Km Moyen"
FROM    LOCVEC.MODELE MO
        INNER JOIN LOCVEC.VEHICULE VE ON (MO.cdmdl = VE.cdmdl)
        INNER JOIN LOCVEC.CONTRAT CTR ON (VE.cdvhc = CTR.cdvhc)
        INNER JOIN LOCVEC.CATEGORIE CTG ON (CTG.cdctg = MO.cdctg)
WHERE  UPPER(CTG.intctg) = 'MONOSPACE'
GROUP   BY MO.tpmdl, VE.imtrcl
HAVING AVG (CTR.kmrtr-CTR.kmdpt) > 1000
ORDER   BY "Nb Km Moyen" DESC;

--R25

SELECT  MO.marque||' '||MO.tpmdl AS Modèle,
        VE.imtrcl AS "Immat.",
        COUNT(CTR.cdctr) AS "Nb.Contrats",
        SUM(CTR.DATRTR - CTR.DATDPT) AS "Nb Jours",
        ROUND(AVG (CTR.DATRTR - CTR.DATDPT), 2) AS "Moy.Jours",
        SUM(CTR.KMRTR - CTR.KMDPT) AS "Nb Km",
        ROUND(AVG (CTR.KMRTR - CTR.KMDPT), 2) AS "Moy.Km"
FROM    LOCVEC.CONTRAT CTR
        INNER JOIN LOCVEC.VEHICULE VE ON (CTR.cdvhc = VE.cdvhc)
        INNER JOIN LOCVEC.MODELE MO ON (VE.cdmdl = MO.cdmdl)
WHERE   UPPER(Mo.marque) IN ('RENAULT','OPEL')
GROUP   BY MO.marque, MO.tpmdl, VE.imtrcl
HAVING  COUNT(CTR.cdctr) > 2
        AND SUM(CTR.DATRTR - CTR.DATDPT) >= 10
ORDER   BY Modèle;

--R26

--a

SELECT  MAX(COUNT(cdctr)) AS "Nb. Max de Contrats"
FROM    LOCVEC.CONTRAT
GROUP   BY cdvhc;

--b

SELECT  MO.marque||'-'||MO.tpmdl AS Modèle,
        VE.imtrcl AS Immatriculation
FROM    LOCVEC.MODELE MO
        INNER JOIN LOCVEC.VEHICULE VE ON (MO.cdmdl = VE.cdmdl)
        INNER JOIN LOCVEC.CONTRAT CTR ON (VE.cdvhc = CTR.cdvhc)
GROUP   BY MO.marque||'-'||MO.tpmdl, VE.imtrcl
HAVING  COUNT(ctr.cdctr) =  (SELECT  MAX(COUNT(cdctr))
                             FROM    LOCVEC.CONTRAT
                             GROUP   BY cdvhc);

--R27

SELECT  C.nom||' '||C.prnm AS Client,
        COUNT(CTR.cdctr) AS "Nb Contrats"
FROM    LOCVEC.CLIENT C
        INNER JOIN LOCVEC.CONTRAT CTR ON (C.cdcli = CTR.cdcli)
GROUP   BY C.nom, C.prnm
HAVING  COUNT(CTR.cdctr) > (SELECT  AVG(COUNT(cdctr))
                            FROM    LOCVEC.CONTRAT 
                            GROUP   BY cdcli);

--R28

--a

SELECT  COUNT(cdctg) AS "Nb. Catg"
FROM    LOCVEC.CATEGORIE
WHERE   tpvhc = 1;

--b

SELECT  MO.marque AS Modèle,
        COUNT(CTG.cdctg) AS "Nb. Catg"
FROM    LOCVEC.MODELE MO
        INNER JOIN LOCVEC.CATEGORIE CTG ON (MO.cdctg = CTG.cdctg)
WHERE   CTG.tpvhc = 1
GROUP   BY MO.marque
ORDER   BY COUNT(cdctg) DESC;

--c

SELECT  MO.marque AS Modèle
FROM    LOCVEC.MODELE MO
        INNER JOIN LOCVEC.CATEGORIE CTG ON (MO.cdctg = CTG.cdctg)
WHERE   CTG.tpvhc = 1
GROUP   BY MO.marque
HAVING  COUNT(CTG.cdctg) = (SELECT  COUNT(cdctg)
                            FROM    LOCVEC.CATEGORIE
                            WHERE   tpvhc = 1)
ORDER   BY COUNT(CTG.cdctg) DESC;

--R29

SELECT  C.nom||' '||C.prnm AS Client
FROM    LOCVEC.CLIENT C
        INNER JOIN LOCVEC.CONTRAT CTR ON (C.cdcli = CTR.cdcli)
        INNER JOIN LOCVEC.TYPECONTRAT TPCTR ON (CTR.CDTPCTR = TPCTR.CDTPCTR)
GROUP   BY C.nom, C.prnm
HAVING  COUNT(DISTINCT tpctr.cdtpctr) = (SELECT COUNT(cdtpctr)
                                         FROM   LOCVEC.TYPECONTRAT);

SELECT DISTINCT cdtpctr
FROM   LOCVEC.CONTRAT;