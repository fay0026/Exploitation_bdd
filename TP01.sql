--FAY Damien INF-S2 TP5B

--Exercice 3
--R1

SELECT  CL.nom||' '||CL.prnm AS Client,
        DECODE(EM.cdsx, 2, 'Madame', 'Monsieur')||' '||EM.nom||' '||EM.prnm AS Employé,
        TO_CHAR(datctr, 'YYYY') AS "Année Contrat",
        localite AS Localité
FROM    LOCVEC.CLIENT CL 
        INNER JOIN LOCVEC.CONTRAT CT ON (CL.cdcli = CT.cdcli)
        INNER JOIN LOCVEC.EMPLOYE EM ON (CT.cdemp = EM.cdemp)
WHERE   UPPER(CL.localite) NOT LIKE 'REIMS%'
        AND EM.cdsx = '2'
        AND TO_CHAR(CT.datctr, 'MM') = '09'
ORDER   BY CT.datctr DESC, Client;

--R2

SELECT  CL.nom||' '||CL.prnm AS Client,
        MO.cdmdl||' '||MO.tpmdl AS Modèle,
        VE.imtrcl AS Immatriculation
FROM    LOCVEC.CLIENT CL 
        INNER JOIN LOCVEC.CONTRAT CT ON (CL.cdcli = CT.cdcli)
        INNER JOIN LOCVEC.VEHICULE VE ON (CT.cdvhc = VE.cdvhc)
        INNER JOIN LOCVEC.MODELE MO ON (VE.cdmdl = MO.cdmdl)
WHERE   TO_CHAR(CT.datctr, 'MM YYYY') = '09 2018'
        AND (sysdate - CL.DATPRMS)/365.25 > 10
ORDER   BY MO.marque, Client;

--R3 (INNER JOIN)

SELECT  MO.marque||' '||MO.tpmdl AS Modèle,
        VE.imtrcl AS Immatriculation,
        VE.datpmc AS "Année Mise en circulation"
FROM    LOCVEC.VEHICULE VE 
        INNER JOIN LOCVEC.MODELE MO ON (VE.cdmdl = MO.cdmdl)
        INNER JOIN LOCVEC.CATEGORIE CA ON (MO.cdctg = CA.cdctg)
WHERE   UPPER(CA.intctg) = 'STANDARD'
ORDER   BY VE.datpmc;

--R3 (SOUS-REQUÊTE)

SELECT  MO.marque||' '||MO.tpmdl AS Modèle,
        VE.imtrcl AS Immatriculation,
        VE.datpmc AS "Année Mise en circulation"
FROM    LOCVEC.VEHICULE VE 
        INNER JOIN LOCVEC.MODELE MO ON (VE.cdmdl = MO.cdmdl)
WHERE   cdctg IN (SELECT   cdctg
                     FROM     LOCVEC.CATEGORIE 
                     WHERE    UPPER(intctg) = 'STANDARD')
ORDER   BY VE.datpmc;

--R4 (INNER JOIN)

SELECT  DISTINCT CL.nom||' '||CL.prnm AS Client,
        DECODE(SUBSTR(CL.CP,1,2), '51', 'MARNE', 'AUTRE') AS Département
FROM    LOCVEC.CLIENT CL
        INNER JOIN LOCVEC.CONTRAT CT ON (CL.cdcli = CT.cdcli)
        INNER JOIN LOCVEC.TYPECONTRAT TPCT ON (TPCT.cdtpctr = CT.cdtpctr)
WHERE   MONTHS_BETWEEN(sysdate, CL.datns)/12 BETWEEN 50 AND 60
        AND UPPER(TPCT.inttpctr) LIKE '%FORFAITAIRE%';

--R4 (SOUS-REQUÊTE)

SELECT  CL.nom||' '||CL.prnm AS Client,
        DECODE(SUBSTR(CL.CP,1,2), '51', 'MARNE', 'AUTRE') AS Département
FROM    LOCVEC.CLIENT CL
WHERE   MONTHS_BETWEEN(sysdate, CL.datns)/12 BETWEEN 50 AND 60
        AND CL.cdcli IN (SELECT CT.cdcli
                         FROM   LOCVEC.CONTRAT CT
                         WHERE  CT.cdtpctr IN (SELECT   TPCT.cdtpctr
                                               FROM     LOCVEC.TYPECONTRAT TPCT
                                               WHERE    UPPER(TPCT.inttpctr) LIKE '%FORFAITAIRE%'));

--R5 (INNER JOIN)

SELECT  DISTINCT VE.imtrcl AS Immatriculation,
        VE.datpmc AS Ancienneté,
        VE.kmactl AS kilométrage
FROM    LOCVEC.VEHICULE VE 
        INNER JOIN LOCVEC.MODELE MO ON (VE.cdmdl = MO.cdmdl)
        INNER JOIN LOCVEC.CONTRAT CTR ON (VE.cdvhc = CTR.cdvhc)
WHERE   MO.marque IN ('OPEL','RENAULT','PEUGEOT');

--R5 (SOUS-REQUÊTE)

SELECT  VE.imtrcl AS Immatriculation,
        VE.datpmc AS Ancienneté,
        VE.kmactl AS kilométrage
FROM    LOCVEC.VEHICULE VE
WHERE   VE.cdmdl IN (SELECT cdmdl
                     FROM   LOCVEC.MODELE
                     WHERE  marque IN ('OPEL','RENAULT','PEUGEOT'))
        AND VE.cdvhc IN (SELECT cdvhc
                         FROM   LOCVEC.CONTRAT);

--R6
SELECT  DISTINCT CA.intctg AS Catégorie,
        NVL2(MO.marque, MO.marque||' '||MO.tpmdl, 'Pas de modèle') AS Modèle
FROM    LOCVEC.CATEGORIE CA
        LEFT JOIN LOCVEC.MODELE MO ON (CA.cdctg = MO.cdctg)
WHERE   CA.tpvhc = 2;

--R7 (INNER JOIN)
SELECT  C.nom AS Client
FROM    LOCVEC.CLIENT C
        LEFT JOIN LOCVEC.CONTRAT CT ON (C.cdcli = CT.cdcli)
WHERE   CT.cdctr IS NULL;

--R7 (SOUS-REQUÊTE)
SELECT  nom AS Client
FROM    LOCVEC.CLIENT
WHERE   cdcli NOT IN (SELECT  cdcli
                      FROM    LOCVEC.CONTRAT);

--R8 (INNER JOIN)
SELECT  MO.Marque as Modèle,
        CT.intctg as Catégorie
FROM    LOCVEC.MODELE MO
        INNER JOIN LOCVEC.CATEGORIE CT ON (MO.cdctg = CT.cdctg)
        LEFT JOIN LOCVEC.VEHICULE VE ON (MO.cdmdl = VE.cdmdl)
WHERE   VE.cdmdl IS NULL;

--R8 (SOUS-REQUÊTE)
SELECT  MO.Marque as Modèle,
        CT.intctg as Catégorie
FROM    LOCVEC.MODELE MO
        INNER JOIN LOCVEC.CATEGORIE CT ON (MO.cdctg = CT.cdctg)
WHERE   MO.cdmdl NOT IN (SELECT cdmdl
                         FROM   LOCVEC.VEHICULE);

--R9
SELECT  E.nom||' '||E.prnm AS Employé,
        E.qualif AS "Qualif Employé",
        E2.nom||' '||E2.prnm AS Supérieur,
        E2.qualif AS "Qualif Supérieur"
FROM    LOCVEC.EMPLOYE E
        INNER JOIN LOCVEC.EMPLOYE E2 ON (E.cdsup = E2.cdemp)
ORDER   BY Supérieur, Employé;

--R10
SELECT  E.nom||' '||E.prnm AS Employé,
        E.qualif AS "Qualif Employé",
        NVL2(E.cdsup, E2.nom||' '||E2.prnm, '********') AS Supérieur,
        NVL(E2.qualif, NVL2(E.datdpt, 'Ancien Employé', 'Directeur de l agence')) AS "Qualif Supérieur"
FROM    LOCVEC.EMPLOYE E
        LEFT JOIN LOCVEC.EMPLOYE E2 ON (E.cdsup = E2.cdemp);


