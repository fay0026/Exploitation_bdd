--FAY Damien Inf-S2 TP5B

DROP TABLE PARTICIPATION CASCADE CONSTRAINTS;

--Exercice 1

--a

CREATE TABLE PARTICIPATION AS (
    SELECT  cdcompet, 
            cdpers AS cdmemb, 
            dateregltcompet
    FROM    MINIGOLF.PARTICIPER
    ) ;
    
--b

ALTER TABLE PARTICIPATION ADD (
    CONSTRAINT pk_constraint PRIMARY KEY (cdcompet, cdmemb),
    CONSTRAINT fk_constraint_cdcompet FOREIGN KEY (cdcompet) REFERENCES competition(cdcompet),
    CONSTRAINT fk_constraint_dateregltcompet FOREIGN KEY (cdmemb) REFERENCES membre(cdmemb));
    
--c

ALTER TABLE PARTICIPATION
    ADD resultatobt NUMBER
    ADD CONSTRAINT resultatobt_range CHECK (resultatobt BETWEEN 0 AND 36);
    
--d

UPDATE PARTICIPATION
    SET     resultatobt = 40
    WHERE   UPPER(cdmemb) = 'M005'
            AND UPPER(cdcompet) = 'C001' OR UPPER(cdcompet) = 'C002';
            
--Npus avons un problème d'insertion car 40 est plus grand que 36, qui est le
--maximum défini pour resultatobt par la contrainte.

UPDATE PARTICIPATION
    SET     resultatobt = 30
    WHERE   UPPER(cdmemb) = 'M005'
            AND (UPPER(cdcompet) = 'C001' OR UPPER(cdcompet) = 'C002');

--e

DELETE FROM PARTICIPATION
    WHERE dateregltcompet is Null;
    
COMMIT;

--f

DELETE FROM PARTICIPATION
    WHERE cdmemb IN    (SELECT  cdmemb
                        FROM    MEMBRE
                        WHERE   UPPER(nom) = 'MOERS' AND UPPER(prnm) = 'ROBERT');

ROLLBACK;

--g

SELECT  C.cdcompet,
        M.cdmemb
FROM    COMPETITION C
        JOIN PARTICIPATION T ON (C.cdcompet = T.cdcompet)
        JOIN MEMBRE M ON (T.cdmemb = M.cdmemb)
WHERE   M.ind > C.indmax;

DELETE FROM PARTICIPATION
    WHERE (cdmemb, cdcompet) IN (   SELECT  M.cdmemb, C.cdcompet
                                    FROM    COMPETITION C
                                        JOIN PARTICIPATION T ON (C.cdcompet = T.cdcompet)
                                        JOIN MEMBRE M ON (T.cdmemb = M.cdmemb)
                                     WHERE   M.ind > C.indmax);

--h

DELETE FROM PARTICIPATION;

--Exercice 2

--a

CREATE SEQUENCE MA_SEQ
    INCREMENT BY 1
    START WITH 4
    MAXVALUE 9;

SELECT MA_SEQ.CURRVAL FROM DUAL;
SELECT MA_SEQ.NEXTVAL FROM DUAL;
SELECT MA_SEQ.NEXTVAL FROM DUAL;

--b

DROP SEQUENCE MA_SEQ;

CREATE SEQUENCE MA_SEQ
    INCREMENT BY 1
    START WITH 4
    MAXVALUE 9;

--c
SELECT MA_SEQ.NEXTVAL FROM DUAL;
SELECT MA_SEQ.NEXTVAL FROM DUAL;
SELECT MA_SEQ.NEXTVAL FROM DUAL;
SELECT MA_SEQ.NEXTVAL FROM DUAL;

INSERT INTO TYPESTAGE 
VALUES (SELECT MA_SEQ.CURRVAL FROM DUAL,
        'Stage Initiation Parcours');
        
SELECT MA_SEQ.NEXTVAL FROM DUAL;








