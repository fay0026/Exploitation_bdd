DROP TABLE COMPETITION CASCADE CONSTRAINTS;
DROP TABLE REGLT_COTISATION CASCADE CONSTRAINTS;

--Exercice 2 : Création de table

--a

CREATE TABLE COMPETITION
(
    CDCOMPET        CHAR(5),
    LIBCOMPET       VARCHAR2(50)    not null,
    DATECOMPET      DATE DEFAULT SYSDATE,
    PARCOURS        NUMBER
        constraint CKC_PARCOURS check (parcours in ('1','2')),
    INDMAX          NUMBER
        constraint CKC_INDMAX check (indmax between 0 and 36),
    DROITSINSC      NUMBER(8,2),
    CONSTRAINT PK_COMPETITION PRIMARY KEY (CDCOMPET)
);

--b

INSERT INTO COMPETITION
VALUES ('TE01', 'Compet 1', TO_DATE('03/04/2019', 'DD/MM/YYYY'), 1, 13, 17);
        
INSERT INTO COMPETITION
VALUES ('TE02', 'Compet 2', TO_DATE('05/04/2019', 'DD/MM/YYYY'), 2, 15, 18);
        
INSERT INTO COMPETITION
VALUES ('TE03', 'Compet 3', TO_DATE('10/04/2019', 'DD/MM/YYYY'), 2, 24, 25);
        
INSERT INTO COMPETITION
VALUES ('TE04', 'Compet 4', Null, 2, 25, 25);
        
INSERT INTO COMPETITION
VALUES ('TE05', 'Compet 5', TO_DATE('16/04/2019', 'DD/MM/YYYY'), 1, 45, 14);

--Changement de la dernière insertion, car il y a une restriction de 0 à 36,
--et la valeur étant 45, cela provoque une erreur.
--La date affectée à la 4ème insertion est la (null), la valeur de base n'a
--donc pas été utilisée

INSERT INTO COMPETITION (cdcompet, libcompet, parcours, indmax, droitsinsc)
VALUES ('TE05', 'Compet 5', 1, 13, 17);

--c

INSERT INTO COMPETITION
SELECT * FROM MINIGOLF.COMPETITION;

--d

DELETE FROM COMPETITION
WHERE CDCOMPET LIKE 'TE%';

--e

UPDATE COMPETITION
SET droitsInsc = droitsInsc * 1.1
WHERE parcours = 2;

--Exercice 3

--a

INSERT INTO MONITEUR
VALUES ('M2', 'TORDUE', 'Paul', '20, Rue Nationale', 'LA NEUVILETTE', 51100, 'M1', 1, 3);

--La contrainte d'intégrité référentielle n'est pas respectée, car le moniteur M1 n'a pas
--encore été créé.

--b

ALTER TABLE MONITEUR 
    ADD CONSTRAINT fk_type FOREIGN KEY(responsable) 
                                REFERENCES MONITEUR(cdmono) ON DELETE CASCADE;

DELETE
FROM MONITEUR
WHERE cdmono = 'M1';

--c

INSERT INTO MONITEUR
VALUES ('M1', 'DUMAS', 'Arnaud', '14, Bd Gambetta', 'REIMS', 51100, '', 2, 1);

INSERT INTO MONITEUR
VALUES ('M2', 'TORDUE', 'Paul', '20, Rue Nationale', 'LA NEUVILETTE', 51100, 'M1', 1, 3);

--d

INSERT INTO MEMBRE (cdmemb, nom, prnm, adr, ville, cp, tpmemb, nbcoursuivis, ind)
SELECT cdpers, nom, prnm, adr, ville, cp, tpmemb, nbcoursuivis, ind FROM MINIGOLF.PERSONNE WHERE tpmemb != 3;

--SELECT * ne peut pas marcher à cause d'une valeur supplémentaire située dans
--la table personne, il faut donc individuellement choisir les champs.

--e

UPDATE MEMBRE
SET nom = UPPER(nom);

--Exercice 4

--a

CREATE TABLE REGLT_COTISATION
(
    CDMEMB        CHAR(5) CONSTRAINT fk_type_cdmb REFERENCES MEMBRE(cdmemb),
    DATEREGLTCOT  DATE        not null,
    MNTREGLE      VARCHAR(40) not null CHECK (mntregle > 0),
    CONSTRAINT PK_REGLT_COTISATION PRIMARY KEY (cdmemb, dateregltcot)
);

--b

INSERT INTO REGLT_COTISATION
VALUES ('M000', '01/07/2004', 10);

INSERT INTO REGLT_COTISATION
VALUES ('M001', NULL, 10);

INSERT INTO REGLT_COTISATION
VALUES ('M001', '01/07/2004', 0);

--c

INSERT INTO REGLT_COTISATION
VALUES ('M012', TO_DATE('25/01/2019', 'DD/MM/YYYY'), 40);
INSERT INTO REGLT_COTISATION
VALUES ('M020', TO_DATE('30/01/2019', 'DD/MM/YYYY'), 20);
INSERT INTO REGLT_COTISATION
VALUES ('M005', TO_DATE('30/01/2019', 'DD/MM/YYYY'), 20);
INSERT INTO REGLT_COTISATION
VALUES ('M006', TO_DATE('30/01/2019', 'DD/MM/YYYY'), 50);
INSERT INTO REGLT_COTISATION
VALUES ('M012', SYSDATE, 50);
INSERT INTO REGLT_COTISATION
VALUES ('M020', SYSDATE, 60);
INSERT INTO REGLT_COTISATION
VALUES ('M005', TO_DATE('12/02/2019', 'DD/MM/YYYY'), 60);

--UPDATE REGLT_COTISATION
--SET mntregle = mntregle + 20
--WHERE cdmemb = 'M005' AND TO_CHAR(dateregltcot, 'DD/MM/YYYY') = '12/02/2019';

INSERT INTO REGLT_COTISATION
VALUES ('M011', SYSDATE - 1, 50);
INSERT INTO REGLT_COTISATION
VALUES ('M020', SYSDATE - 7, 20);

--d

SELECT M.nom, M.prnm, SUM(C.mntregle)
FROM MEMBRE M JOIN REGLT_COTISATION C ON (M.cdmemb = C.cdmemb)
GROUP BY M.nom, M.prnm;

--e

SELECT  M.nom||' '||M.prnm AS "MEMBRE",
        NVL2(SUM(C.mntregle), SUM(C.mntregle)||' €','Rien Rayé') AS "Mnt Total"
FROM    MEMBRE M LEFT JOIN REGLT_COTISATION C ON (M.cdmemb = C.cdmemb)
WHERE   UPPER(M.ville) = 'REIMS'
GROUP   BY M.nom, M.prnm;

--f

SELECT  M.nom||' '||M.prnm AS "MEMBRE",
        SUM(C.mntregle)||' €' AS "Mnt Total"
FROM    MEMBRE M JOIN REGLT_COTISATION C ON (M.cdmemb = C.cdmemb)
GROUP   BY M.nom, M.prnm
HAVING  SUM(C.mntregle) =  (SELECT  MAX(SUM(mntregle))
                            FROM    REGLT_COTISATION
                            GROUP   BY cdmemb);

--g

UPDATE REGLT_COTISATION
SET mntregle = mntregle + 10
WHERE TRUNC(dateregltcot) = TRUNC(SYSDATE);

--h

DELETE FROM REGLT_COTISATION
WHERE cdmemb IN (   SELECT  cdmemb
                    FROM    MEMBRE
                    WHERE   UPPER(ville) = 'REIMS');














